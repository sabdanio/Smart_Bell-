{% extends 'base.html' %}

{% block style %}
<link rel="stylesheet" href="/static/css/login.css">
{% endblock %}

{% block content %}
<h1>üéô –ì–æ–≤–æ—Ä–∏—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ</h1>
<button id="startBtn">–ó–∞–ø–∏—Å—å</button>
<button id="stopBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

<script>
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.");
}


    let mediaRecorder;
    let audioChunks = [];

    document.getElementById("startBtn").onclick = async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.start();

        mediaRecorder.ondataavailable = (e) => {
            audioChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
            const blob = new Blob(audioChunks, { type: "audio/webm" });
            const formData = new FormData();
            formData.append("file", blob, "voice.webm");

            fetch("/api/upload", {
                method: "POST",
                body: formData
            })
            .then(res => {
                if (res.ok) {
                    alert("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!");
                } else {
                    alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ.");
                }
            });
        };

        document.getElementById("startBtn").disabled = true;
        document.getElementById("stopBtn").disabled = false;
    };

    document.getElementById("stopBtn").onclick = () => {
        mediaRecorder.stop();
        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
    };
</script>

{% endblock %}
